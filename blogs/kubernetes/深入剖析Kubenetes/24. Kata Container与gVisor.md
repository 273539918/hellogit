# Kubernetes容器运行时

## 46 绝不仅仅是安全：Kata Container与gVisor

Kata Container本质就是一个精简后的轻量级虚拟机，所以它的特点，就是“像虚拟机一样安全，像容器一样敏捷”。而在2018年，Google公司则发布了一个叫gVisor的项目。gVisort项目给容器进程配置一个用Go语言实现的、运行在用户态的、极小的“独立内核”。这个内核对容器进程暴露Linux内核ABI，扮演者“Guest Kernel”的角色，从而达到了将容器和宿主机隔离开的目的

> API和ABI ?
>
> API （应用程序接口）： 定义了源代码和库之间的接口
> ABI（应用二进制接口） ：定义了一组编译应用程序所需要遵循的规则。比如寄存器如何使用、堆栈如何使用等等
>
> API兼容： 代码可以在相互兼容的API系统中编译
> ABI兼容： 编译好的代码可以在相互兼容的ABI系统中运行

不难看到，无论是Kata Containers，还是gVisor，它们实现安全容器的方法其实是殊途同归的。这两种容器实现的本质，都是给进程分配一个独立的操作系统内核，从而避免了让容器共享宿主机的内核。这样，容器进程能够看到的攻击面，就从整个宿主机内核变成了一个极小的、独立的、以容器为单位的内核，从而有效解决了容器进程发生“逃逸”或者夺取整个宿主机的控制权的问题。这个原因，可以用如下示意图来表示清楚。

![img](https://static001.geekbang.org/resource/image/95/1d/959c4c40c767acb6a3ffe6e144202e1d.png)

而它们的区别在于，Kata Containers 使用的是传统的虚拟化技术，通过虚拟硬件模拟出了一台“小虚拟机”，然后在这个小虚拟机里安装了一个裁剪后的Linux内核来实现强隔离。而gVisor的做法则更加激进，Google的工程师直接用Go语言“模拟”出了一个运行在用户态的操作系统内核，然后通过这个模拟的内核来代替容器进程向宿主机发起有限的、可控的系统调用。

gVisor虽然现在没有任何优势，但是这种通过在用户态运行一个操作系统内核，来为应用进程提供强隔离的思路，的确是未来安全容器进一步演化的一个非常有前途的方向。值得一提的是，Kata Containers团队在gVisor之前，就已经Demo了一个名叫Linuxd的项目。这个项目，使用了User Mode Linux（UML）技术，在用户态运行起了一个真正的Linux Kernel来为应用进程提供强隔离，从而避免了重新实现Linux Kernel带来的各种麻烦。相信，这个方向，应该才是安全容器进化的未来。