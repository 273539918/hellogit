# Kubernetes集群搭建与实践

## 10  Kubernetes一键部署利器： kubeadm



### 10.1 kubeadm的工作原理

kubeadm选择的集群部署方案：  把kubelet直接运行在宿主机上，然后使用容器部署其他的Kubernetes组件。

那么，为什么kubelet不与其他组件一样使用容器来部署呢？
Kubelet是Kubernetes项目用来操作Docker等容器运行时的核心组件。可是，除了跟容器运行时打交道外，kubelet在配置容器网络、管理容器数据卷时，都需要直接操作宿主机。如果kublet运行在一个容器里，那么直接操作宿主机就会变得非常麻烦。对于网络配置来说还好，kubelet容器可以通过不开启Network Namespace（即 Docker的host network模式）的方式，直接共享宿主机的网络栈。可是，要让kubelet隔着容器的Mount Namespace和文件系统，操作宿主机的文件系统，就非常困难了。比如，如果用户想要使用NFS做容器的持久化数据卷，那么kubelet就需要在容器进行绑定挂载前，在宿主机的指定目录上，先挂载NFS的远程目录。可是，由于现在kubelet是运行在容器里的，这就意味着它要做的这个"mount -F nfs"命令，被隔离在了一个单独的Mount Namespace中。即， kubelet做的挂载操作，不能被“传播”到宿主机上。

所以，使用kubeadm的第一步，是在机器上手动安装kubeadm，kubelet和kubectl 

### 10.1 使用kubeadm

安装kubeadm

```
$yum install kubeadm
```

#### 10.1.1 预检查

安装完成之后，就可以使用 kubeadm init 部署Master节点了。当执行kubeadm init指令后，kubeadm首先要做的，是一列的检查工作，以确定这台机器可以用来部署kubernetes。检查（Preflight Checks）包括：

- Linux内核的版本是否是3.10以上？
- Linux Cgroups模块是否可用？
- 机器的hostname是否标准？在Kubernetes项目中，机器的名字存储在Etcd中的API对象，都必须使用标准的DNS命名
- 用户安装的kubeadm和kubelet的版本是否匹配
- .......

#### 10.1.2 证书生成

在通过了Preflight Checks之后，kubeadm要为你做的，是生成Kubernetes对外提供服务所需的各种证书和对应的目录。

Kubernetes对外提供服务时，除非专门开启“不安全模式”，否则都要通过HTTPS才能访问kube-apiserver。这就需要为Kubernetes集群配置好证书文件。kubeadm为Kubernetes项目生成的证书文件都放在Master节点的/etc/kubernetes/pki目录下。在这个目录下，最主要的证书文件是ca.crt和对应的私钥ca.key。

此外，用户使用kubectl获取容器日志等streaming操作时，需要通过kube-apiserver向kubelet发起请求，这个连接也必须是安全的。kubeadm为这一步生成的是apiserver-kubelet-client.crt文件，对应的私钥是apiserver-kubelet-client.key。除此之外，Kubernetes集群中还有Aggregate APIServer等，也需要用到专门的证书，这里不再列举。需要指出的是，你可以选择不让kubeadm为你生成这些证书，而是拷贝现有的证书到如下证书的目录：

```
/etc/kubernetes/pki/ca.{crt,key}
```

这时，kubeadm就会跳过证书生成的步骤，把它完全交给用户处理。

#### 10.1.3 配置文件生成

证书生成后，kubeadm接下来会为其他组件生成访问kube-apiserver所需的配置文件。这些配置文件的路径是：/etc/kubernetes/xxx.conf: 

```
$ls /etc/kubernetes/ | grep conf
admin.conf
controller-manager.conf
kubelet.conf
scheduler.conf
```

这些文件里面记录的是，当前这个Master节点的服务器地址、监听端口、证书目录等信息。这样，对应的客户端（比如 scheduler，kubelet等），可以直接加在相应的文件，使用里面的信息与kube-apiserver建立安全连接。

接下来，kubeadm会为Master组件生成pod配置文件来启动Master上的组件。Kubernetes有三个Master组件，分别是kube-apiserver、kube-controller-manager、 kube-scheduler，它们都会被使用Pod的方式部署起来。你可能会有疑问，Kubernetes集群尚不存在，这些Pod是如何部署起来的？
这是因为在Kubernetes中，有一种特殊的容器启动方法叫做“Static Pod”。它允许你把要部署的Pod的YAML文件放在一个指定的目录里。这样，当这台机器上的kubelet启动时，它会自动检查这个目录，加在所有的Pod YAML文件，然后在这台机器上启动它们。从这一点也可以看出，kubelet在Kubernetes项目中的地位非常高，在设计上它就是一个安全独立的组件，而其他Master组件，则更像是辅助性的系统容器。在kubeadm中，Master组件的YAML文件会被生成在/etc/kubernetes/mainifests路径下。这一步完成后，kubeadm还会再生成一个Etcd的Pod YAML文件，用来通过同样的Static Pod的方式启动Etcd。所以，最后Master组件的Pod YAML文件如下所示：

```
$ ls /etc/kubernetes/manifests/
etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml
```

#### 10.1.4 Master容器拉起

Kubelet启动后，根据/etc/kubernetes/manifests/中的YAML文件拉起Master容器，kubeadm会通过检查localhost:6443/healthz这个Master组件的健康检查URL，等待Master组件完全运行起来

Master容器启动后，kubeadm就会为集群生成一个bootstrap token。在后面，只要持有这个token，任何一个安装了kubelet和kubead的节点，都可以通过kubeadm join加入到这个集群当中。这个token的值和使用方法，会在kubeadm init结束后被打印出来。如果token后续过期，可以使用kubeadm token create来创建一个新的

```
#kubeadm token create
W0401 19:00:33.291573  244373 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
2gu78y.xshxiuwn6h3tjmhw
```



在token生成之后，kubeadm会将ca.crt等Master节点的重要信息，通过ConfigMap的方式保存在Etcd中，供后续部署Node节点使用。这个ConfigMap的名字是cluster-info

 #### 10.1.5 安装插件

kubeadm init 的最后一步，就是安装默认插件。Kubernetes默认kube-proxy和DNS这两个插件是必须安装的。它们分别用来提供整个集群的服务发现和DNS功能。其实，这两个插件也只是两个容器镜像而已，所以kubeadm只要用Kubernetes客户端创建两个Pod就可以了

#### 10.1.6 Node节点拉起

Node节点拉起，是通过kubeadm join来完成。这个流程其实非常简单，kubeadm init生成bootstrap token之后，你就可以在任意一台安装了kubelet和kubeadm的机器上执行kubeadm join了。

为什么需要这个token呢？因为任何一台机器想要成为Kubernetes集群中的一个节点，就必须在集群的kube-apiserver上注册。可是，要想跟api-server打交道，这台机器就必须要获取到相应的证书文件（CA文件）。可是，为了能够一键安装，我们就不能让用户去Master节点上手动拷贝这些文件。所以kubeadm至少需要发起一次“不安全模式”的访问到kube-apiserver，从而拿到保存在ConfigMap中的cluster-info（它保存了APIServer的授权信息）。而bootstrap token，扮演的就是这个过程中的安全验证的角色。

只要有了cluster-info里的kube-apiserver的地址、端口、证书、kubelet就可以以“安全模式”连接到apiserver上，这样一个新的节点就部署完成了。

##### 10.1.7 配置kubeadm的部署参数

前面介绍的kubeadm init和kubeadm join非常简单易用，可是我们如何定制我的集群组件参数呢？ 比如，我要指定kube-apiserver的启动参数，该如何操作？

推荐在使用kubeadm init部署Master节点时，使用下面这条指令：

```
$ kubeadm init --config kubeadm.yaml
```

这时，就可以给kubeadm提供一个YAML文件，它的内容如下所示

```
apiVersion: kubeadm.k8s.io/v1alpha2
kind: MasterConfiguration
kubernetesVersion: v1.11.0
api:
  advertiseAddress: 192.168.0.102
  bindPort: 6443
  ...
etcd:
  local:
    dataDir: /var/lib/etcd
    image: ""
imageRepository: k8s.gcr.io
kubeProxy:
  config:
    bindAddress: 0.0.0.0
    ...
kubeletConfiguration:
  baseConfig:
    address: 0.0.0.0
    ...
networking:
  dnsDomain: cluster.local
  podSubnet: ""
  serviceSubnet: 10.96.0.0/12
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  ...
```

这样，我要指定kube-apiserver的参数，就只要在文件里加上这样一段：

```
...
apiServerExtraArgs:
  advertise-address: 192.168.0.103
  anonymous-auth: false
  enable-admission-plugins: AlwaysPullImages,DefaultStorageClass
  audit-log-path: /home/johndoe/audit.log
```

然后，kubeadm就会使用上面这些信息替换/etc/kubernetes/mainifests/kube-apiserver.yaml里的command字段里的参数。你还可以修改kubelet和kube-proxy的配置，修改kubernetes使用的基础镜像的URL，指定自己的证书文件，指定特殊的容器运行时等等。



#### 10.1.8 kubeadm的欠缺

kubeadm能方便地搭建一个kubernetes的集群，但是不能用于生产环境，原因是目前kubeadm搭建起来的master节点是单点。kubeadm目前最欠缺的俄式，一键部署一个高可用的kubernetes集群，即：Etcd、Master组件都应该是多节点集群。这也正是kubeadm接下来发展的主要方向

 



