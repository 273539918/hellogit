## 谷歌集群架构

很少有Web服务像搜索引擎那样需要对每个请求进行大量的计算。平均一个请求需要读取数百兆字节数据，并消耗数百亿个CPU周期。要支持每秒数千个查询的高峰请求流，就需要一个与大型超级计算机安装规模相当的基础架构。将超过15,000台商用级PC与容错软件相结合，所创建的解决方案比采用少量高端服务器构建的同类系统更具成本效益

在这里，我们介绍了Google集群的体系结构，并讨论了影响其设计的最重要因素：能源效率和性价比。

我们的应用程序提供了简单的并行化：不同的查询可以在不同的处理器上运行，并且总索引已分区，因此单个查询可以使用多个处理器。因此，处理器的性价比会比峰值处理性能更重要。

## Google架构概述

Google的软件架构来自两个基础。首先，Google提供软件级而不是服务器级硬件的可靠性，因此可以使用商用PC以低端价格构建高端计算集群。其次，由于可以通过并行处理单个请求来应对服务器响应时间，我们针对最佳聚合请求吞吐量而不是峰值服务器响应时间进行设计

我们认为，从不可靠的商用PC集群中构建可靠的计算基础架构能够为应用程序提供最佳的性价比。通过在许多不同的机器上复制服务并自动检测和处理故障，我们在软件级别的环境中提供了可靠性。这种基于软件的可靠性涵盖许多不同领域，涉及我们系统设计的所有部分

### Google查询服务

当用户向Google输入查询（例如www.google.com/search?q=ieee+society）时，用户的浏览器会首先执行域名系统（DNS）查找，以将www.google.com映射到特定的IP地址。为了提供足够的容量来处理查询流量，我们的服务由遍布全球的多个集群组成。每个集群大约有数千台计算机，而且地理分布的设置可以保护我们免受灾难性的数据中心故障（例如由于地震和大规模电源故障引起的故障）的影响。基于DNS的负载平衡系统通过考虑用户与每个物理群集的地理位置相近来选择群集。负载平衡系统可最大程度地缩短用户请求的往返时间，同时还考虑了各个群集的可用容量。

然后，用户的浏览器向这些集群之一发送超文本传输协议（HTTP）请求，此后，对该查询的处理完全在该集群本地进行。每个集群中基于硬件的负载平衡器监视可用的Google Web服务器（GWS）集合，并对其中的一组请求执行本地负载平衡。收到查询后，GWS机器会协调查询执行并将结果格式化为对用户浏览器的超文本标记语言（HTML）响应。 图1说明了这些步骤。查询执行包括两个主要阶段。在第一阶段，索引服务器查询反向索引，该索引将每个查询词映射到匹配的文档列表（命中列表）。索引服务器然后通过与各个查询词的命中列表相交来确定一组相关文档，并且它们为每个文档计算相关性得分。此相关性分数决定了输出页面上结果的顺序。

由于数据量大，搜索过程具有挑战性：原始文档包含数十TB的未压缩数据，并且由该原始数据产生的反向索引本身就是许多TB的数据。幸运的是，通过将索引分为多个部分（索引分片），搜索可以高度并行化，每个部分都具有从完整索引中随机选择的文档子集。如果某个分片的副本出现故障，负载均衡器将避免使用它进行查询，并且我们的集群管理系统的其他组件将尝试恢复该副本或最终将其替换为另一台计算机。

查询执行的第一阶段的最终结果是文档标识符（docid）的有序列表。第二阶段涉及获取此docid列表，并计算这些文档的实际标题和统一资源定位符，以及特定于查询的文档摘要。文档服务器（文档服务器）处理此工作，从磁盘上获取每个文档以提取标题和上下文关键字摘要。与索引查找阶段一样，策略是通过以下方式划分所有文档的处理：
1:随机将文档分发到较小的碎片中
2:有多个服务器副本负责处理每个分片
3: 通过负载均衡器路由请求
文档服务器群集必须有权访问整个Web的联机低延迟副本。实际上，由于副本的性能和可用性需求，因此Google在其群集中存储了数十个Web副本。除了建立索引和提供文件的阶段外，GWS还会在收到查询后启动其他一些辅助任务，例如将查询发送到拼写检查系统和广告服务系统以生成相关广告。完成所有阶段后，GWS会为输出页面生成适当的HTML，并将其返回给用户的浏览器。

### 使用副本实现可用性和容错

我们已经对系统进行了结构设计，以便大多数访问索引和其他与查询相关的数据结构都是只读的：更新相对不频繁，并且我们通常可以通过在更新过程中将查询从服务副本中转移来安全地执行它们。该原则回避了在使用通用数据库时通常会出现的许多一致性问题。

我们还积极地利用了应用程序中非常大量的固有并行性：例如，我们将大索引中匹配文档的查找转换为许多较小索引中的匹配文档查找，然后进行了合并。同样，我们将查询流分为多个流，每个流由一个集群处理。在每个池中添加计算机可增加服务容量，而添加分片可适应索引的增长。通过在许多机器上进行并行搜索，我们减少了响应查询所需的平均等待时间，将总计算量分配给了更多的CPU和磁盘。由于各个分片无需相互通信，因此加速几乎是线性的。换句话说，各个索引服务器的CPU速度不会直接影响搜索的整体性能，因为我们可以增加分片的数量以适应速度较慢的CPU，反之亦然。因此，我们的硬件选择过程侧重于为我们的应用程序提供出色请求吞吐量的计算机，而不是提供最高单线程性能的计算机。

总而言之，Google集群遵循以下三个主要设计原则：

软件可靠性：从软件层面容忍故障，而不是从硬件层面去解决

使用多副本以获得更好的请求吞吐量和可用性：由于机器本质上是不可靠的，因此我们在许多机器上复制了每个内部服务。因为我们已经跨多台机器复制了服务以获得足够的容量，所以这种容错几乎是免费的。

价格/性能优于峰值性能：我们购买的是当前性价比最高的CPU，而不是性能最好的CPU。

使用商用PC可以降低计算成本： 结果，我们可以负担每个查询使用更多的计算资源，在我们的排名算法中使用更昂贵的技术，或者搜索更大的文档索引。

## 利用商品零件

Google的机架由40到80个基于x86的服务器组成，这些服务器安装在定制机架的两侧（机架的每一侧包含20个20u或40u 服务器）。已有几代CPU投入使用，从单处理器533 MHz基于Intel-Celeron的服务器到双1.4 GHz Intel Pentium III服务器。



